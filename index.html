<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anandvan - Management</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        /* --- Base & Typography --- */
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --primary-deep: #004d40;
            --primary-light: #00796b;
            --accent-gold: #ffc107;
            --surface-color: #ffffff;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --danger-color: #dc3545;
            --font-family: 'Poppins', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            --border-radius: 12px;
            --print-green: #008000;
        }

        body { font-family: var(--font-family); margin: 0; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; min-height: 100vh; }

        /* --- Main App Layout --- */
        .app-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: var(--surface-color); box-shadow: 0 2px 10px var(--shadow-color); position: sticky; top: 0; z-index: 1000; }
        .brand { display: flex; align-items: center; gap: 1rem; }
        .brand h1 { margin: 0; font-size: 1.5rem; color: var(--primary-deep); }
        .brand p { margin: 0; color: #6c757d; }
        .logo-small { width: 48px; height: 48px; }
        .app-nav { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .nav-tab { padding: 0.75rem 1.5rem; border: none; background-color: transparent; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 500; color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .nav-tab:hover { background-color: #e9ecef; }
        .nav-tab.active { background: var(--accent-gold); color: var(--primary-deep); font-weight: bold; }
        .logout-button { background: transparent; border: 1px solid var(--border-color); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; }
        .app-main { flex-grow: 1; padding: 2rem; }
        .app-view { display: none; }
        .app-view.active { display: block; }

        /* --- Components --- */
        .primary-button { background: var(--primary-light); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
        .primary-button:hover { opacity: 0.9; }
        .secondary-button { background: #f1f3f5; color: var(--text-color); border: 1px solid var(--border-color); padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .danger-button { background: var(--danger-color); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .hidden-input { display: none; }
        .button-like-label { display: inline-block; padding: 0.75rem 1.5rem; background-color: #6c757d; color: white; border-radius: 8px; cursor: pointer; text-align: center; }
        input, select, textarea { width: 100%; padding: 0.7rem; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 1rem; }
        input:focus, select:focus, textarea:focus { outline: 2px solid var(--accent-gold); }
        input[type="color"] { padding: 0.2rem; height: 40px; }

        /* --- Dashboard, Tables, Modal --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--surface-color); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: 0 4px 12px var(--shadow-color); text-align: center; }
        .stat-card h3 { margin: 0 0 0.5rem 0; color: var(--primary-light); font-size: 1rem; }
        .stat-card p { margin: 0; font-size: 2.25rem; font-weight: bold; color: var(--primary-deep); }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; }
        .chart-container { background: var(--surface-color); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: 0 4px 12px var(--shadow-color); }
        .view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        .view-controls { display: flex; gap: 1rem; align-items: center; }
        .view-controls input[type="search"] { width: 250px; }
        .table-container { background: var(--surface-color); border-radius: var(--border-radius); box-shadow: 0 4px 12px var(--shadow-color); overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .data-table th { font-weight: 600; color: var(--primary-deep); }
        .action-buttons button { border: none; background: none; cursor: pointer; font-size: 1.2rem; margin-right: 0.5rem; padding: 0; }
        .paid-status { padding: 0.2rem 0.6rem; border-radius: 1rem; font-size: 0.8rem; font-weight: bold; }
        .paid-yes { background-color: #d1e7dd; color: #0f5132; }
        .paid-no { background-color: #f8d7da; color: #842029; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--surface-color); padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 600px; position: relative; max-height: 90vh; overflow-y: auto; }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; border: none; background: none; font-size: 1.5rem; cursor: pointer; }
        .modal-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .modal-form .full-width { grid-column: 1 / -1; }
        .modal-form > label { display: block; margin-bottom: 0.5rem; }
        .modal-checkbox-group { display: flex; gap: 2rem; padding-top: 0.5rem; align-items: center; }
        .modal-checkbox-group label { display: flex; align-items: center; cursor: pointer; margin-bottom: 0; }
        .modal-checkbox-group input[type="checkbox"] { width: auto; margin-right: 0.5rem; }

        /* --- Settings --- */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 1.5rem; }
        .settings-card { background: var(--surface-color); padding: 1.5rem; border-radius: var(--border-radius); box-shadow: 0 4px 12px var(--shadow-color); }
        .form-card { display: flex; flex-direction: column; gap: 1rem; }
        .form-card h3 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        .data-buttons { display: flex; flex-direction: column; gap: 1rem; }

        /* --- Invoice Studio --- */
        .studio-layout { display: grid; grid-template-columns: 300px 1fr; gap: 1.5rem; height: calc(100vh - 120px); }
        .studio-sidebar { background: var(--surface-color); padding: 1rem; border-radius: var(--border-radius); overflow-y: auto; display: flex; flex-direction: column; }
        .studio-main { background: var(--surface-color); padding: 0; border-radius: var(--border-radius); box-shadow: 0 4px 12px var(--shadow-color); overflow-y: hidden; display: flex; flex-direction: column; }
        #invoice-content { display: flex; flex-direction: column; height: 100%; }
        .invoice-controls { flex-shrink: 0; padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .item-add-form { display: flex; gap: 0.5rem; align-items: center; }
        .item-add-form select { width: auto; }
        .item-add-form input { width: 60px; }
        .invoice-actions button { margin-left: 0.5rem; }
        .studio-preview-pane { flex-grow: 1; overflow-y: auto; padding: 1.5rem; }
        .invoice-booking-list { list-style: none; padding: 0; margin: 1rem 0 0 0; }
        .invoice-booking-list li { padding: 0.75rem; border-radius: 8px; cursor: pointer; border: 1px solid transparent; transition: background-color 0.2s; }
        .invoice-booking-list li:hover { background-color: #f1f3f5; }
        .invoice-booking-list li.active { background-color: #e0f2f1; border-color: var(--primary-light); font-weight: bold; }
        #invoice-placeholder { display: flex; justify-content: center; align-items: center; height: 100%; color: #6c757d; padding: 1.5rem; }
        .hidden { display: none !important; }

        /* --- Simple Invoice Preview Styles --- */
        .invoice-preview-wrapper { max-width: 800px; margin: 0 auto; }
        .invoice-preview-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .invoice-preview-table th, .invoice-preview-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .invoice-preview-table th { font-weight: 600; color: var(--primary-deep); }
        .invoice-preview-table td:nth-child(2), .invoice-preview-table td:nth-child(3), .invoice-preview-table td:nth-child(4) { text-align: right; }
        .invoice-preview-table tfoot td { text-align: right; font-weight: bold; }
        .invoice-preview-table tfoot tr.total td { font-size: 1.2rem; color: var(--primary-deep); border-top: 2px solid var(--primary-deep); }
        .action-btn-remove { border: none; background: none; cursor: pointer; font-size: 1rem; padding: 0.25rem; }

        /* --- Simple Print Styles --- */
        .isp-wrapper, .isp-footer { display: none; } /* Hide print styles from screen view */

        @media print {
            body { background-color: #fff; padding: 0; margin: 0; }
            .app-header, .studio-layout, .invoice-controls, .invoice-preview-wrapper, .modal-overlay, .app-main { display: none !important; }
            #invoice-print-area { display: block !important; padding: 0; }
            .isp-wrapper { display: block; font-family: var(--font-family); color: #333; }
            .isp-header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 10mm; border-top: 5px solid var(--print-green); padding-top: 10mm; }
            .isp-header-left .isp-logo { height: 18mm; max-width: 60mm; object-fit: contain; margin-bottom: 5mm; }
            .isp-header-left p { margin: 0; font-size: 10pt; line-height: 1.4; white-space: pre-wrap; }
            .isp-header-right { text-align: center; }
            .isp-qr-code { width: 35mm; height: 35mm; border: 1px solid var(--border-color); padding: 2mm; border-radius: 4px; }
            .isp-header-right p { margin: 1mm 0 0 0; font-size: 8pt; }
            .isp-title { border-bottom: 1px solid var(--border-color); padding-bottom: 8mm; margin-bottom: 8mm; }
            .isp-title h1 { color: var(--print-green); font-size: 24pt; margin: 0 0 2mm 0; }
            .isp-title p { margin: 0; font-size: 11pt; }
            .isp-parties { display: flex; justify-content: space-between; font-size: 10pt; margin-bottom: 10mm; }
            .isp-parties > div { width: 30%; }
            .isp-parties h3 { font-size: 9pt; color: #888; margin: 0 0 2mm 0; text-transform: uppercase; letter-spacing: 0.5px; }
            .isp-parties p { margin: 1mm 0; line-height: 1.4; }
            .isp-items-table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-bottom: 10mm; }
            .isp-items-table thead { border-bottom: 2px solid #333; }
            .isp-items-table th { padding: 3mm 1mm; text-align: left; color: #555; font-weight: bold; }
            .isp-items-table td { padding: 3mm 1mm; border-bottom: 1px solid #eee; }
            .isp-items-table th:nth-child(3), .isp-items-table td:nth-child(3),
            .isp-items-table th:nth-child(4), .isp-items-table td:nth-child(4),
            .isp-items-table th:nth-child(5), .isp-items-table td:nth-child(5) { text-align: right; }
            .isp-totals { margin-left: auto; width: 50%; max-width: 250px; font-size: 11pt; }
            .isp-totals table { width: 100%; }
            .isp-totals td { padding: 3mm; }
            .isp-totals td:last-child { text-align: right; }
            .isp-totals tr:not(.grand-total) td { color: #555; }
            .isp-totals tr.grand-total td { font-weight: bold; font-size: 14pt; border-top: 2px solid #333; color: #333; }
            .isp-footer { display: block; text-align: center; margin-top: 15mm; padding-top: 5mm; border-top: 1px solid var(--border-color); font-size: 9pt; color: #888; }
            @page { size: A4 portrait; margin: 20mm; }
        }

        /* --- Responsive --- */
        @media (max-width: 992px) {
            .app-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .studio-layout { grid-template-columns: 1fr; height: auto; }
            .settings-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .app-main { padding: 1rem; }
            .view-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .modal-form { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="brand">
            <img id="header-logo" src="./logo.png" alt="Anandvan Logo" class="logo-small">
            <div>
                <h1 id="header-brand-name">Anandvan</h1>
                <p id="header-tagline">A Nature Homestay</p>
            </div>
        </div>
        <nav class="app-nav">
            <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
            <button class="nav-tab" data-tab="bookings">Bookings</button>
            <button class="nav-tab" data-tab="expenses">Expenses</button>
            <button class="nav-tab" data-tab="invoice-studio">Invoice Studio</button>
            <button class="nav-tab" data-tab="settings">Settings</button>
        </nav>
        <button id="logout-button" class="logout-button">Logout</button>
    </header>

    <main class="app-main">
        <section id="dashboard-view" class="app-view active">
            <div class="dashboard-grid">
                <div class="stat-card"><h3>MTD Income</h3><p id="mtd-income">‚Çπ0</p></div>
                <div class="stat-card"><h3>MTD Expenses</h3><p id="mtd-expenses">‚Çπ0</p></div>
                <div class="stat-card"><h3>YTD Income</h3><p id="ytd-income">‚Çπ0</p></div>
                <div class="stat-card"><h3>YTD Expenses</h3><p id="ytd-expenses">‚Çπ0</p></div>
                <div class="stat-card"><h3>Cafe Total (YTD)</h3><p id="ytd-cafe">‚Çπ0</p></div>
                <div class="stat-card"><h3>Stay Total (YTD)</h3><p id="ytd-stay">‚Çπ0</p></div>
                <div class="stat-card"><h3>Invoices (YTD)</h3><p id="ytd-invoices">0</p></div>
                <div class="stat-card"><h3>Active Bookings</h3><p id="active-bookings">0</p></div>
            </div>
            <div class="charts-grid">
                <div class="chart-container"><canvas id="cafeVsStayChart"></canvas></div>
                <div class="chart-container"><canvas id="revenueBySourceChart"></canvas></div>
                <div class="chart-container"><canvas id="expenseBreakdownChart"></canvas></div>
            </div>
        </section>

        <section id="bookings-view" class="app-view">
            <div class="view-header">
                <h2>Bookings</h2>
                <div class="view-controls">
                    <input type="search" id="booking-search" placeholder="Search bookings...">
                    <button id="export-bookings-csv" class="secondary-button">Export CSV</button>
                    <button id="add-booking-btn" class="primary-button">New Booking</button>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Check-in</th><th>Guest</th><th>Room</th><th>Source</th><th>Nights</th><th>Room Rate</th>
                            <th>Caf√© Bill</th><th>Total</th><th>Stay Paid</th><th>Caf√© Paid</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bookings-table-body"></tbody>
                </table>
            </div>
        </section>

        <section id="expenses-view" class="app-view">
            <div class="view-header">
                <h2>Expenses</h2>
                <div class="view-controls">
                    <input type="search" id="expense-search" placeholder="Search expenses...">
                    <button id="export-expenses-csv" class="secondary-button">Export CSV</button>
                    <button id="add-expense-btn" class="primary-button">New Expense</button>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th><th>Category</th><th>Subcategory</th><th>Vendor</th><th>Amount</th><th>Method</th><th>Notes</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-table-body"></tbody>
                </table>
            </div>
        </section>

        <section id="invoice-studio-view" class="app-view">
            <div class="studio-layout">
                <div class="studio-sidebar">
                    <h3>Select Booking</h3>
                    <input type="search" id="invoice-booking-search" placeholder="Search by guest or invoice...">
                    <ul id="invoice-booking-list" class="invoice-booking-list"></ul>
                </div>
                <div class="studio-main">
                    <div id="invoice-placeholder">
                        <p>Select a booking from the left to manage their caf√© bill.</p>
                    </div>
                    <div id="invoice-content" class="hidden">
                        <div class="invoice-controls">
                            <h3>Add Caf√© Items</h3>
                            <div class="item-add-form">
                                <select id="menu-item-select"></select>
                                <input type="number" id="menu-item-qty" value="1" min="1">
                                <button id="add-cafe-item-btn" class="primary-button">Add Item</button>
                            </div>
                            <div class="invoice-actions">
                                <button id="print-cafe-bill" class="secondary-button">Print Caf√© Bill</button>
                                <button id="print-voucher" class="secondary-button">Print Full Voucher</button>
                            </div>
                        </div>
                        <div class="studio-preview-pane">
                            <div id="invoice-print-area"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="settings-view" class="app-view">
            <h2>Settings</h2>
            <div class="settings-grid">
                <form id="settings-form" class="settings-card form-card">
                    <h3>Business Details</h3>
                    <label>Business Name <input type="text" name="name"></label>
                    <label>Tagline <input type="text" name="tagline"></label>
                    <label>Address <textarea name="address" rows="4"></textarea></label>
                    <label>Phone <input type="tel" name="phone"></label>
                    <label>Email <input type="email" name="email"></label>
                    <label>Payment Recipient Name <input type="text" name="paymentRecipientName"></label>
                    <label>Logo URL <input type="text" name="logoUrl"></label>
                    <label>QR Code URL <input type="text" name="qrCodeUrl"></label>
                    
                    <h3>Financials</h3>
                    <label>Invoice Prefix <input type="text" name="invoicePrefix"></label>
                    <label>Convenience Fee (%)<input type="number" name="convenienceFeePercentage" step="0.1"></label>
                    <label>Currency Code (e.g., INR) <input type="text" name="currency"></label>
                    <label>Currency Symbol (Fallback) <input type="text" name="currencySymbol" style="width: 50px;"></label>

                    <h3>Invoice</h3>
                    <label>Default Invoice Notes <textarea name="defaultInvoiceNotes" rows="3"></textarea></label>
                </form>
                
                <div class="settings-card form-card">
                    <h3>Theme Customization</h3>
                    <label>Primary Color (Deep) <input type="color" name="primaryDeepColor"></label>
                    <label>Primary Color (Light) <input type="color" name="primaryLightColor"></label>
                    <label>Accent Color <input type="color" name="accentGoldColor"></label>
                    <label>Application Font
                        <select name="fontFamily" id="font-family-select"></select>
                    </label>
                </div>

                <div class="settings-card">
                    <h3>Menu Editor</h3>
                    <p>Enter items as <code>Name, Price</code>, one per line.</p>
                    <textarea id="menu-editor" rows="10"></textarea>
                    <button id="save-menu-btn" class="secondary-button">Save Menu</button>
                </div>

                <div class="settings-card">
                    <h3>Data Management</h3>
                    <div class="data-buttons">
                        <button id="export-json-btn" class="secondary-button">Backup (Export JSON)</button>
                        <label class="button-like-label">Restore (Import JSON)<input type="file" id="import-json-input" accept=".json" class="hidden-input"></label>
                        <button id="reset-data-btn" class="danger-button">Reset All Data</button>
                    </div>
                </div>
            </div>
            <button type="submit" form="settings-form" class="primary-button" style="margin-top: 2rem; width: 100%;">Save All Settings</button>
        </section>
    </main>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <h2 id="modal-title">Modal Title</h2>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <script src="config.js" defer></script>
    <script>
        /**
         * ANANDVAN MANAGEMENT TOOL
         * All application logic is contained within this file, under the ANV namespace.
         */

        const ANV = {
            state: { settings: {}, bookings: [], expenses: [], menu: [] },
            elements: {}, charts: {}, activeBookingId: null, activeExpenseId: null, activeInvoiceBookingId: null,

            theme: {
                apply: () => {
                    const { settings } = ANV.state;
                    const defaults = window.ANV_CONFIG.settings;
                    const root = document.documentElement;
                    
                    root.style.setProperty('--primary-deep', settings.primaryDeepColor || defaults.primaryDeepColor);
                    root.style.setProperty('--primary-light', settings.primaryLightColor || defaults.primaryLightColor);
                    root.style.setProperty('--accent-gold', settings.accentGoldColor || defaults.accentGoldColor);
                    root.style.setProperty('--font-family', `"${settings.fontFamily || defaults.fontFamily}", sans-serif`);

                    const existingFontLink = document.getElementById('google-font-link');
                    if (existingFontLink) existingFontLink.remove();

                    const font = settings.fontFamily || defaults.fontFamily;
                    if (font) {
                        const link = document.createElement('link');
                        link.id = 'google-font-link';
                        link.rel = 'stylesheet';
                        link.href = `https://fonts.googleapis.com/css2?family=${font.replace(/ /g, '+')}:wght@400;500;700&display=swap`;
                        document.head.appendChild(link);
                    }
                }
            },

            util: {
                num: (val) => Number(String(val).replace(/,/g, '')) || 0,
                money: (n) => {
                    const { currency, currencySymbol } = ANV.state.settings;
                    const amount = ANV.util.num(n);
                    try {
                        return new Intl.NumberFormat('en-IN', { style: 'currency', currency: currency || 'INR', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
                    } catch (e) {
                        return `${currencySymbol || '‚Çπ'}${amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    }
                },
                uid: (prefix) => `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                today: () => new Date().toISOString().split('T')[0],
                nights: (checkIn, checkOut) => {
                    if (!checkIn || !checkOut) return 1;
                    const ci = new Date(checkIn); const co = new Date(checkOut);
                    if (isNaN(ci) || isNaN(co) || co <= ci) return 1;
                    return Math.max(1, Math.ceil(Math.abs(co - ci) / 864e5));
                },
                nextInvoiceNo: () => {
                    const prefix = ANV.state.settings.invoicePrefix; const year = new Date().getFullYear();
                    const yearPrefix = `${prefix}-${year}-`;
                    const currentYearInvoices = ANV.state.bookings.map(b => b.invoiceNo).filter(inv => inv && inv.startsWith(yearPrefix));
                    if (currentYearInvoices.length === 0) return `${yearPrefix}001`;
                    const maxNum = currentYearInvoices.reduce((max, inv) => {
                        const num = parseInt(inv.substring(yearPrefix.length), 10);
                        return num > max ? num : max;
                    }, 0);
                    return `${yearPrefix}${(maxNum + 1).toString().padStart(3, '0')}`;
                },
            },

            stateManager: {
                save: () => localStorage.setItem(window.ANV_CONFIG.localStorageKey, JSON.stringify(ANV.state)),
                load: () => {
                    const savedState = localStorage.getItem(window.ANV_CONFIG.localStorageKey);
                    if (savedState) {
                        const loadedState = JSON.parse(savedState);
                        ANV.state = {
                            ...loadedState,
                            settings: {
                                ...window.ANV_CONFIG.settings,
                                ...loadedState.settings
                            }
                        };
                    } else {
                        ANV.state = { 
                            settings: window.ANV_CONFIG.settings, 
                            bookings: [], 
                            expenses: [], 
                            menu: [] 
                        };
                        if(ANV.state.bookings.length === 0 && ANV.state.expenses.length === 0) {
                            ANV.state.bookings = window.ANV_CONFIG.seedData.bookings || [];
                            ANV.state.expenses = window.ANV_CONFIG.seedData.expenses || [];
                            ANV.state.menu = window.ANV_CONFIG.seedData.menu || [];
                        }
                        ANV.stateManager.save();
                    }
                }
            },

            render: {
                all: () => { ANV.render.header(); ANV.render.dashboard(); ANV.render.bookings(); ANV.render.expenses(); ANV.render.invoiceStudio(); ANV.render.settings(); },
                header: () => {
                    const { settings } = ANV.state;
                    ANV.elements.header.logo.src = settings.logoUrl;
                    ANV.elements.header.brandName.textContent = settings.name;
                    ANV.elements.header.tagline.textContent = settings.tagline;
                },
                dashboard: () => {
                    const { bookings, expenses } = ANV.state; const now = new Date();
                    const currentYear = now.getFullYear(); const currentMonth = now.getMonth();
                    const ytdBookings = bookings.filter(b => new Date(b.checkOut).getFullYear() === currentYear);
                    const ytdExpenses = expenses.filter(e => new Date(e.date).getFullYear() === currentYear);
                    const mtdBookings = ytdBookings.filter(b => new Date(b.checkOut).getMonth() === currentMonth);
                    const mtdExpenses = ytdExpenses.filter(e => new Date(e.date).getMonth() === currentMonth);
                    const ytdIncome = ytdBookings.reduce((s, b) => s + ANV.util.num(b.total), 0);
                    const ytdExpensesTotal = ytdExpenses.reduce((s, e) => s + ANV.util.num(e.amount), 0);
                    const mtdIncome = mtdBookings.reduce((s, b) => s + ANV.util.num(b.total), 0);
                    const mtdExpensesTotal = mtdExpenses.reduce((s, e) => s + ANV.util.num(e.amount), 0);
                    const ytdCafe = ytdBookings.reduce((s, b) => s + ANV.util.num(b.cafeBill), 0);
                    const ytdStay = ytdBookings.reduce((s, b) => s + (ANV.util.num(b.roomRate) * ANV.util.num(b.nights)), 0);
                    const activeBookings = bookings.filter(b => new Date(b.checkOut) >= now && new Date(b.checkIn) <= now).length;
                    ANV.elements.dashboard.mtdIncome.textContent = ANV.util.money(mtdIncome);
                    ANV.elements.dashboard.mtdExpenses.textContent = ANV.util.money(mtdExpensesTotal);
                    ANV.elements.dashboard.ytdIncome.textContent = ANV.util.money(ytdIncome);
                    ANV.elements.dashboard.ytdExpenses.textContent = ANV.util.money(ytdExpensesTotal);
                    ANV.elements.dashboard.ytdCafe.textContent = ANV.util.money(ytdCafe);
                    ANV.elements.dashboard.ytdStay.textContent = ANV.util.money(ytdStay);
                    ANV.elements.dashboard.ytdInvoices.textContent = ytdBookings.length;
                    ANV.elements.dashboard.activeBookings.textContent = activeBookings;
                    if (ANV.charts.cafeVsStay) ANV.render.charts.cafeVsStay(ytdBookings);
                    if (ANV.charts.revenueBySource) ANV.render.charts.revenueBySource(ytdBookings);
                    if (ANV.charts.expenseBreakdown) ANV.render.charts.expenseBreakdown(ytdExpenses);
                },
                charts: {
                    cafeVsStay: (bookings) => {
                        const monthlyData = Array(12).fill(0).map(() => ({ stay: 0, cafe: 0 }));
                        bookings.forEach(b => { const month = new Date(b.checkOut).getMonth(); monthlyData[month].cafe += ANV.util.num(b.cafeBill); monthlyData[month].stay += ANV.util.num(b.roomRate) * ANV.util.num(b.nights); });
                        ANV.charts.cafeVsStay.data.datasets[0].data = monthlyData.map(d => d.stay); ANV.charts.cafeVsStay.data.datasets[1].data = monthlyData.map(d => d.cafe); ANV.charts.cafeVsStay.update();
                    },
                    revenueBySource: (bookings) => {
                        const sources = window.ANV_CONFIG.bookingSources; const sourceData = {}; sources.forEach(s => sourceData[s] = 0);
                        bookings.forEach(b => { if (sourceData.hasOwnProperty(b.source)) sourceData[b.source] += ANV.util.num(b.total); });
                        ANV.charts.revenueBySource.data.labels = Object.keys(sourceData); ANV.charts.revenueBySource.data.datasets[0].data = Object.values(sourceData); ANV.charts.revenueBySource.update();
                    },
                    expenseBreakdown: (expenses) => {
                        const categories = window.ANV_CONFIG.expenseCategories; const expenseData = {}; categories.forEach(c => expenseData[c] = 0);
                        expenses.forEach(e => { if (expenseData.hasOwnProperty(e.category)) expenseData[e.category] += ANV.util.num(e.amount); });
                        ANV.charts.expenseBreakdown.data.labels = Object.keys(expenseData); ANV.charts.expenseBreakdown.data.datasets[0].data = Object.values(expenseData); ANV.charts.expenseBreakdown.update();
                    }
                },
                bookings: (filter = '') => {
                    const tableBody = ANV.elements.bookings.tableBody;
                    const searchTerm = filter.toLowerCase();
                    const filteredBookings = ANV.state.bookings.filter(b => b.guest.toLowerCase().includes(searchTerm) || (b.invoiceNo && b.invoiceNo.toLowerCase().includes(searchTerm)) || (b.phone && b.phone.includes(searchTerm)) || (b.email && b.email.toLowerCase().includes(searchTerm)) || b.source.toLowerCase().includes(searchTerm) || b.room.toLowerCase().includes(searchTerm));
                    tableBody.innerHTML = filteredBookings.map(b => `
                        <tr>
                            <td>${b.checkIn}</td> <td>${b.guest}</td> <td>${b.room}</td> <td>${b.source}</td>
                            <td>${b.nights}</td> <td>${ANV.util.money(b.roomRate)}</td> <td>${ANV.util.money(b.cafeBill)}</td>
                            <td>${ANV.util.money(b.total)}</td>
                            <td><span class="paid-status ${b.stayPaid ? 'paid-yes' : 'paid-no'}">${b.stayPaid ? 'Yes' : 'No'}</span></td>
                            <td><span class="paid-status ${b.cafePaid ? 'paid-yes' : 'paid-no'}">${b.cafePaid ? 'Yes' : 'No'}</span></td>
                            <td class="action-buttons">
                                <button onclick="ANV.handlers.showBookingModal('${b.id}')" title="Edit">‚úèÔ∏è</button>
                                <button onclick="ANV.handlers.onDeleteBooking('${b.id}')" title="Delete">üóëÔ∏è</button>
                            </td>
                        </tr>`).join('');
                },
                expenses: (filter = '') => {
                    const tableBody = ANV.elements.expenses.tableBody; const searchTerm = filter.toLowerCase();
                    const filteredExpenses = ANV.state.expenses.filter(e => Object.values(e).some(val => String(val).toLowerCase().includes(searchTerm)));
                    tableBody.innerHTML = filteredExpenses.map(e => `
                        <tr>
                            <td>${e.date}</td> <td>${e.category}</td> <td>${e.subcategory || ''}</td>
                            <td>${e.vendor || ''}</td> <td>${ANV.util.money(e.amount)}</td> <td>${e.paymentMethod || ''}</td>
                            <td>${e.notes || ''}</td>
                            <td class="action-buttons">
                                <button onclick="ANV.handlers.showExpenseModal('${e.id}')" title="Edit">‚úèÔ∏è</button>
                                <button onclick="ANV.handlers.onDeleteExpense('${e.id}')" title="Delete">üóëÔ∏è</button>
                            </td>
                        </tr>`).join('');
                },
                invoiceStudio: (filter = '') => {
                    const listEl = ANV.elements.invoice.bookingList;
                    const searchTerm = filter.toLowerCase();
                    const filteredBookings = ANV.state.bookings.filter(b => b.guest.toLowerCase().includes(searchTerm) || (b.invoiceNo && b.invoiceNo.toLowerCase().includes(searchTerm))).sort((a, b) => new Date(b.checkIn) - new Date(a.checkIn));
                    listEl.innerHTML = filteredBookings.map(b => `<li onclick="ANV.handlers.onSelectInvoiceBooking('${b.id}')" class="${b.id === ANV.activeInvoiceBookingId ? 'active' : ''}"><strong>${b.guest}</strong><br><small>${b.invoiceNo || 'No Invoice'} | ${b.checkIn}</small></li>`).join('');
                    ANV.elements.invoice.menuItemSelect.innerHTML = ANV.state.menu.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
                    ANV.render.invoicePreview();
                },
                invoicePreview: () => {
                    const booking = ANV.state.bookings.find(b => b.id === ANV.activeInvoiceBookingId);
                    const printArea = ANV.elements.invoice.printArea;
                    if (!booking) {
                        ANV.elements.invoice.content.classList.add('hidden'); ANV.elements.invoice.placeholder.classList.remove('hidden'); printArea.innerHTML = ''; return;
                    }
                    ANV.elements.invoice.content.classList.remove('hidden'); ANV.elements.invoice.placeholder.classList.add('hidden');
                    const { settings } = ANV.state;
                    const cafeSubtotal = (booking.cafeItems || []).reduce((sum, item) => sum + ANV.util.num(item.amount), 0);
                    const convenienceFee = cafeSubtotal * (ANV.util.num(settings.convenienceFeePercentage) / 100);
                    const cafeTotal = cafeSubtotal + convenienceFee;

                    const renderSimplePreview = () => {
                        const cafeItems = booking.cafeItems || [];
                        return `
                        <div class="invoice-preview-wrapper">
                            <h2>Caf√© Bill For: ${booking.guest}</h2>
                            <p><strong>Invoice No:</strong> ${booking.invoiceNo || 'N/A'}</p>
                            <table class="invoice-preview-table">
                                <thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Amount</th><th></th></tr></thead>
                                <tbody>
                                    ${cafeItems.length > 0 ? cafeItems.map(item => `
                                    <tr>
                                        <td>${item.item}</td>
                                        <td>${item.qty}</td>
                                        <td>${ANV.util.money(item.rate)}</td>
                                        <td>${ANV.util.money(item.amount)}</td>
                                        <td style="width: 1%;"><button class="action-btn-remove" onclick="ANV.handlers.onRemoveCafeItem('${item.id}')" title="Remove Item">üóëÔ∏è</button></td>
                                    </tr>`).join('') : `<tr><td colspan="5" style="text-align:center;">No caf√© items added yet.</td></tr>`}
                                </tbody>
                                <tfoot>
                                    <tr><td colspan="4">Subtotal</td><td>${ANV.util.money(cafeSubtotal)}</td></tr>
                                    <tr><td colspan="4">Convenience Fee (${settings.convenienceFeePercentage}%)</td><td>${ANV.util.money(convenienceFee)}</td></tr>
                                    <tr class="total"><td colspan="4">Caf√© Total</td><td>${ANV.util.money(cafeTotal)}</td></tr>
                                </tfoot>
                            </table>
                        </div>`;
                    };
                    
                    const generateSimplePrintHTML = (type) => {
                        const stayTotal = ANV.util.num(booking.roomRate) * ANV.util.num(booking.nights);
                        const grandTotal = stayTotal + cafeTotal;
                        const isVoucher = type === 'voucher';
                        const title = isVoucher ? 'INVOICE' : 'Cafe Bill';
                        const billDate = new Date().toLocaleDateString('en-GB');
                        const items = isVoucher ? [{ item: `Room Stay (${booking.nights} nights)`, qty: 1, rate: stayTotal, amount: stayTotal }, ...(booking.cafeItems || [])] : (booking.cafeItems || []);
                        const notes = booking.notes || settings.defaultInvoiceNotes || "";
                        let totalsHtml;
                        if (isVoucher) {
                            totalsHtml = `<tr><td>Subtotal</td><td>${ANV.util.money(stayTotal + cafeSubtotal)}</td></tr>
                                        <tr><td>Convenience Fee</td><td>${ANV.util.money(convenienceFee)}</td></tr>
                                        <tr class="grand-total"><td>Total</td><td>${ANV.util.money(grandTotal)}</td></tr>`;
                        } else {
                            totalsHtml = `<tr><td>Subtotal</td><td>${ANV.util.money(cafeSubtotal)}</td></tr>
                                        <tr><td>Convenience Fee</td><td>${ANV.util.money(convenienceFee)}</td></tr>
                                        <tr class="grand-total"><td>Total</td><td>${ANV.util.money(cafeTotal)}</td></tr>`;
                        }
                        return `
                        <div class="isp-wrapper">
                            <div class="isp-header">
                                <div class="isp-header-left">
                                    <img src="${settings.logoUrl}" class="isp-logo" alt="Logo">
                                    <p>${settings.address}</p>
                                </div>
                                <div class="isp-header-right">${settings.qrCodeUrl ? `<img src="${settings.qrCodeUrl}" class="isp-qr-code"><p>${settings.name}<br>${settings.paymentRecipientName}</p>` : ''}</div>
                            </div>
                            <div class="isp-title"><h1>${title}</h1><p>${billDate}</p></div>
                            <div class="isp-parties">
                                <div><h3>Invoice for</h3><p>${booking.guest}<br>${booking.phone || ''}</p></div>
                                <div><h3>Payable to</h3><p>${settings.paymentRecipientName}<br>${settings.phone}</p></div>
                                <div><h3>Invoice #</h3><p>${booking.invoiceNo || 'N/A'}</p></div>
                            </div>
                            <table class="isp-items-table">
                                <thead><tr><th>Description</th><th>Date</th><th>Qty</th><th>Unit price</th><th>Total price</th></tr></thead>
                                <tbody>${items.map(item => `<tr><td>${item.item || item.name}</td><td>${billDate}</td><td>${item.qty}</td><td>${ANV.util.money(item.rate)}</td><td>${ANV.util.money(item.amount)}</td></tr>`).join('')}</tbody>
                            </table>
                            <div class="isp-totals"><table>${totalsHtml}</table></div>
                            <div class="isp-footer"><p>${notes}</p></div>
                        </div>`;
                    };
                    printArea.innerHTML = renderSimplePreview();
                    printArea.dataset.cafeBillHtml = generateSimplePrintHTML('cafe');
                    printArea.dataset.voucherHtml = generateSimplePrintHTML('voucher');
                },
                settings: () => {
                    const { settings } = ANV.state;
                    const form = ANV.elements.settings.form;
                    for (const key in settings) {
                        if (form.elements[key]) form.elements[key].value = settings[key];
                    }
                    ANV.elements.settings.menuEditor.value = ANV.state.menu.map(item => `${item.name}, ${item.rate}`).join('\n');
                    const fontSelect = document.getElementById('font-family-select');
                    fontSelect.innerHTML = window.ANV_CONFIG.googleFonts.map(font => `<option value="${font}" ${settings.fontFamily === font ? 'selected' : ''}>${font}</option>`).join('');
                },
            },

            handlers: {
                onTabClick: (e) => {
                    if (!e.target.classList.contains('nav-tab')) return;
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(`${e.target.dataset.tab}-view`).classList.add('active');
                },
                onRemoveCafeItem: (itemId) => {
                    if (!ANV.activeInvoiceBookingId) return;
                    const bookingIndex = ANV.state.bookings.findIndex(b => b.id === ANV.activeInvoiceBookingId);
                    if (bookingIndex === -1) return;
                    const booking = ANV.state.bookings[bookingIndex];
                    booking.cafeItems = booking.cafeItems.filter(item => item.id !== itemId);
                    const cafeSubtotal = booking.cafeItems.reduce((sum, item) => sum + ANV.util.num(item.amount), 0);
                    const convenienceFee = cafeSubtotal * (ANV.util.num(ANV.state.settings.convenienceFeePercentage) / 100);
                    booking.cafeBill = cafeSubtotal + convenienceFee;
                    booking.total = (ANV.util.num(booking.roomRate) * ANV.util.num(booking.nights)) + ANV.util.num(booking.cafeBill);
                    ANV.stateManager.save();
                    ANV.render.invoiceStudio();
                    ANV.render.bookings();
                },
                onAddCafeItem: () => {
                    if (!ANV.activeInvoiceBookingId) return;
                    const bookingIndex = ANV.state.bookings.findIndex(b => b.id === ANV.activeInvoiceBookingId);
                    if (bookingIndex === -1) return;
                    const booking = ANV.state.bookings[bookingIndex];
                    const menuItemId = ANV.elements.invoice.menuItemSelect.value;
                    const qty = ANV.util.num(ANV.elements.invoice.menuItemQty.value);
                    
                    const menuItem = ANV.state.menu.find(m => m.id === menuItemId);

                    if (!menuItem || qty <= 0) {
                        console.error("Could not find menu item with ID:", menuItemId);
                        return;
                    }
                    const newItem = { id: ANV.util.uid('CI'), item: menuItem.name, qty: qty, rate: ANV.util.num(menuItem.rate), amount: ANV.util.num(menuItem.rate) * qty };
                    if (!booking.cafeItems) booking.cafeItems = [];
                    booking.cafeItems.push(newItem);
                    const cafeSubtotal = booking.cafeItems.reduce((sum, item) => sum + ANV.util.num(item.amount), 0);
                    const convenienceFee = cafeSubtotal * (ANV.util.num(ANV.state.settings.convenienceFeePercentage) / 100);
                    booking.cafeBill = cafeSubtotal + convenienceFee;
                    booking.total = (ANV.util.num(booking.roomRate) * ANV.util.num(booking.nights)) + ANV.util.num(booking.cafeBill);
                    ANV.stateManager.save();
                    ANV.render.invoiceStudio();
                    ANV.render.bookings();
                },
                onSaveSettings: (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const feePercentage = ANV.util.num(formData.get('convenienceFeePercentage'));
                    formData.set('convenienceFeePercentage', feePercentage);
                    
                    ANV.state.settings = { ...ANV.state.settings, ...Object.fromEntries(formData.entries()) };
                    ANV.stateManager.save();
                    ANV.theme.apply();
                    ANV.render.all();
                    alert('Settings saved!');
                },
                onPrint: (type) => {
                    const printArea = ANV.elements.invoice.printArea;
                    const htmlToPrint = type === 'cafe' ? printArea.dataset.cafeBillHtml : printArea.dataset.voucherHtml;
                    if (!htmlToPrint) return;
                    const iframe = document.createElement('iframe');
                    iframe.style.position = 'absolute'; iframe.style.width = '0'; iframe.style.height = '0'; iframe.style.border = '0';
                    document.body.appendChild(iframe);
                    const doc = iframe.contentWindow.document;
                    doc.open();
                    doc.write(`<html><head><title>Print</title><link rel="stylesheet" href="style.css"></head><body>${htmlToPrint}</body></html>`);
                    doc.close();
                    setTimeout(() => {
                        try {
                            iframe.contentWindow.focus();
                            iframe.contentWindow.print();
                        } catch(e) {
                            console.error("Print failed:", e);
                            alert("Could not open print dialog. Please check your browser's popup blocker settings.");
                        } finally {
                            document.body.removeChild(iframe);
                        }
                    }, 500);
                },
                showBookingModal: (bookingId = null) => {
                    ANV.activeBookingId = bookingId;
                    const booking = bookingId ? ANV.state.bookings.find(b => b.id === bookingId) : {};
                    const title = bookingId ? 'Edit Booking' : 'New Booking';
                    const formHtml = `
                        <form id="booking-form" class="modal-form">
                            <label class="full-width">Guest Name <input type="text" name="guest" required value="${booking.guest || ''}"></label>
                            <label>Phone <input type="tel" name="phone" value="${booking.phone || ''}"></label>
                            <label>Email <input type="email" name="email" value="${booking.email || ''}"></label>
                            <label>Source <select name="source">${window.ANV_CONFIG.bookingSources.map(s => `<option value="${s}" ${booking.source === s ? 'selected' : ''}>${s}</option>`).join('')}</select></label>
                            <label>Room <select name="room">${window.ANV_CONFIG.roomTypes.map(r => `<option value="${r}" ${booking.room === r ? 'selected' : ''}>${r}</option>`).join('')}</select></label>
                            <label>Check-in <input type="date" name="checkIn" value="${booking.checkIn || ANV.util.today()}"></label>
                            <label>Check-out <input type="date" name="checkOut" value="${booking.checkOut || ''}"></label>
                            <label>Nights <input type="number" name="nights" readonly value="${booking.nights || 1}"></label>
                            <label>Room Rate (per night) <input type="number" name="roomRate" step="0.01" value="${booking.roomRate || ''}"></label>
                            <div class="modal-checkbox-group full-width">
                                <label><input type="checkbox" name="stayPaid" ${booking.stayPaid ? 'checked' : ''}> Stay Paid</label>
                                <label><input type="checkbox" name="cafePaid" ${booking.cafePaid ? 'checked' : ''}> Caf√© Paid</label>
                            </div>
                            <label class="full-width">Notes <textarea name="notes" rows="3">${booking.notes || ''}</textarea></label>
                            <h3 class="full-width">Total: <span id="booking-total">${ANV.util.money(booking.total || 0)}</span></h3>
                            <button type="submit" class="primary-button full-width">Save Booking</button>
                        </form>`;
                    ANV.showModal(title, formHtml);
                    const form = document.getElementById('booking-form');
                    const updateTotals = () => {
                        const nights = ANV.util.nights(form.elements.checkIn.value, form.elements.checkOut.value);
                        form.elements.nights.value = nights;
                        const cafeBill = ANV.activeBookingId ? ANV.util.num(ANV.state.bookings.find(b=>b.id===ANV.activeBookingId).cafeBill) : 0;
                        const total = ANV.util.num(form.elements.roomRate.value) * nights + cafeBill;
                        document.getElementById('booking-total').textContent = ANV.util.money(total);
                    };
                    form.elements.checkIn.addEventListener('change', updateTotals);
                    form.elements.checkOut.addEventListener('change', updateTotals);
                    form.elements.roomRate.addEventListener('input', updateTotals);
                },
                onSaveBooking: (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const formData = new FormData(form);
                    const bookingData = Object.fromEntries(formData.entries());
                    const nights = ANV.util.nights(bookingData.checkIn, bookingData.checkOut);
                    const roomRate = ANV.util.num(bookingData.roomRate);
                    const cafeBill = ANV.activeBookingId ? ANV.util.num(ANV.state.bookings.find(b=>b.id===ANV.activeBookingId).cafeBill) : 0;
                    const updatedBooking = {
                        guest: bookingData.guest, phone: bookingData.phone, email: bookingData.email,
                        source: bookingData.source, room: bookingData.room, checkIn: bookingData.checkIn,
                        checkOut: bookingData.checkOut, nights: nights, roomRate: roomRate,
                        stayPaid: form.elements.stayPaid.checked, cafePaid: form.elements.cafePaid.checked,
                        notes: bookingData.notes, cafeBill: cafeBill,
                        cafeItems: ANV.activeBookingId ? ANV.state.bookings.find(b=>b.id===ANV.activeBookingId).cafeItems : [],
                    };
                    updatedBooking.total = (updatedBooking.roomRate * updatedBooking.nights) + updatedBooking.cafeBill;
                    if (ANV.activeBookingId) {
                        const index = ANV.state.bookings.findIndex(b => b.id === ANV.activeBookingId);
                        ANV.state.bookings[index] = { ...ANV.state.bookings[index], ...updatedBooking };
                    } else {
                        updatedBooking.id = ANV.util.uid('BK');
                        updatedBooking.invoiceNo = ANV.util.nextInvoiceNo();
                        ANV.state.bookings.push(updatedBooking);
                    }
                    ANV.stateManager.save();
                    ANV.render.all();
                    ANV.hideModal();
                },
                onDeleteBooking: (bookingId) => {
                    if (confirm('Are you sure you want to delete this booking? This cannot be undone.')) {
                        ANV.state.bookings = ANV.state.bookings.filter(b => b.id !== bookingId);
                        ANV.stateManager.save();
                        ANV.render.all();
                    }
                },
                showExpenseModal: (expenseId = null) => {
                    ANV.activeExpenseId = expenseId;
                    const expense = expenseId ? ANV.state.expenses.find(e => e.id === expenseId) : {};
                    const title = expenseId ? 'Edit Expense' : 'New Expense';
                    const formHtml = `<form id="expense-form" class="modal-form"><label>Date <input type="date" name="date" required value="${expense.date || ANV.util.today()}"></label><label>Amount <input type="number" name="amount" step="0.01" required value="${expense.amount || ''}"></label><label>Category <select name="category">${window.ANV_CONFIG.expenseCategories.map(c => `<option value="${c}" ${expense.category === c ? 'selected' : ''}>${c}</option>`).join('')}</select></label><label>Payment Method <select name="paymentMethod">${window.ANV_CONFIG.paymentMethods.map(p => `<option value="${p}" ${expense.paymentMethod === p ? 'selected' : ''}>${p}</option>`).join('')}</select></label><label>Subcategory <input type="text" name="subcategory" value="${expense.subcategory || ''}"></label><label>Vendor <input type="text" name="vendor" value="${expense.vendor || ''}"></label><label class="full-width">Notes <textarea name="notes" rows="3">${expense.notes || ''}</textarea></label><button type="submit" class="primary-button full-width">Save Expense</button></form>`;
                    ANV.showModal(title, formHtml);
                },
                onSaveExpense: (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const formData = new FormData(form);
                    const expenseData = Object.fromEntries(formData.entries());
                    const updatedExpense = { ...expenseData, amount: ANV.util.num(expenseData.amount) };
                    if (ANV.activeExpenseId) {
                        const index = ANV.state.expenses.findIndex(ex => ex.id === ANV.activeExpenseId);
                        updatedExpense.id = ANV.activeExpenseId;
                        ANV.state.expenses[index] = updatedExpense;
                    } else {
                        updatedExpense.id = ANV.util.uid('EX');
                        ANV.state.expenses.push(updatedExpense);
                    }
                    ANV.stateManager.save();
                    ANV.render.all();
                    ANV.hideModal();
                },
                onDeleteExpense: (expenseId) => {
                    if (confirm('Are you sure you want to delete this expense? This cannot be undone.')) {
                        ANV.state.expenses = ANV.state.expenses.filter(e => e.id !== expenseId);
                        ANV.stateManager.save();
                        ANV.render.all();
                    }
                },
                onSelectInvoiceBooking: (bookingId) => { ANV.activeInvoiceBookingId = bookingId; ANV.render.invoiceStudio(); },
                onSaveMenu: () => {
                    const menuText = ANV.elements.settings.menuEditor.value;
                    const lines = menuText.split('\n').filter(line => line.trim() !== '');
                    const newMenu = lines.map(line => { const parts = line.split(','); if (parts.length < 2) return null; const name = parts[0].trim(); const rate = ANV.util.num(parts.slice(1).join('').trim()); if (!name || isNaN(rate)) return null; return { id: ANV.util.uid('MENU'), name, rate }; }).filter(Boolean);
                    ANV.state.menu = newMenu;
                    ANV.stateManager.save();
                    ANV.render.invoiceStudio();
                    alert('Menu saved!');
                },
                onImportJson: (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const importedState = JSON.parse(event.target.result);
                            if (importedState.settings && importedState.bookings && importedState.expenses && importedState.menu) {
                                if (confirm('This will replace all current data. Are you sure?')) { ANV.state = importedState; ANV.stateManager.save(); window.location.reload(); }
                            } else { throw new Error("Invalid data structure."); }
                        } catch (err) { alert('Error importing file. Make sure it is a valid backup file.'); } finally { e.target.value = null; }
                    };
                    reader.readAsText(file);
                },
    },

    init: () => {
        if (sessionStorage.getItem('anv_authenticated') !== 'true') { window.location.href = 'login.html'; return; }
        ANV.stateManager.load();
        ANV.cacheElements();
        ANV.theme.apply();
        ANV.initCharts();
        ANV.attachListeners();
        ANV.render.all();
    },

    cacheElements: () => {
        ANV.elements = {
            modal: document.getElementById('modal'), modalTitle: document.getElementById('modal-title'), modalBody: document.getElementById('modal-body'),
            header: { logo: document.getElementById('header-logo'), brandName: document.getElementById('header-brand-name'), tagline: document.getElementById('header-tagline') },
            dashboard: { mtdIncome: document.getElementById('mtd-income'), mtdExpenses: document.getElementById('mtd-expenses'), ytdIncome: document.getElementById('ytd-income'), ytdExpenses: document.getElementById('ytd-expenses'), ytdCafe: document.getElementById('ytd-cafe'), ytdStay: document.getElementById('ytd-stay'), ytdInvoices: document.getElementById('ytd-invoices'), activeBookings: document.getElementById('active-bookings') },
            bookings: { tableBody: document.getElementById('bookings-table-body'), searchInput: document.getElementById('booking-search') },
            expenses: { tableBody: document.getElementById('expenses-table-body'), searchInput: document.getElementById('expense-search') },
            invoice: { bookingList: document.getElementById('invoice-booking-list'), searchInput: document.getElementById('invoice-booking-search'), content: document.getElementById('invoice-content'), placeholder: document.getElementById('invoice-placeholder'), printArea: document.getElementById('invoice-print-area'), menuItemSelect: document.getElementById('menu-item-select'), menuItemQty: document.getElementById('menu-item-qty') },
            settings: { form: document.getElementById('settings-form'), menuEditor: document.getElementById('menu-editor') }
        };
    },
    
    initCharts: () => {
        if (typeof Chart === 'undefined') { console.warn("Chart.js not loaded"); return; }
        Chart.defaults.font.family = 'inherit';
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const chartContexts = {
            cafeVsStay: document.getElementById('cafeVsStayChart'),
            revenueBySource: document.getElementById('revenueBySourceChart'),
            expenseBreakdown: document.getElementById('expenseBreakdownChart')
        };
        if (chartContexts.cafeVsStay) {
            if(ANV.charts.cafeVsStay) ANV.charts.cafeVsStay.destroy();
            ANV.charts.cafeVsStay = new Chart(chartContexts.cafeVsStay, { type: 'bar', data: { labels: months, datasets: [{ label: 'Stay Revenue', data: [], backgroundColor: ANV.state.settings.primaryDeepColor },{ label: 'Caf√© Revenue', data: [], backgroundColor: ANV.state.settings.accentGoldColor }] }, options: { responsive: true, plugins: { title: { display: true, text: 'Cafe vs Stay Revenue (YTD)' } }, scales: { x: { stacked: true }, y: { stacked: true } } } });
            
            if(ANV.charts.revenueBySource) ANV.charts.revenueBySource.destroy();
            ANV.charts.revenueBySource = new Chart(chartContexts.revenueBySource, { type: 'bar', data: { labels: [], datasets: [{ label: 'Total Revenue', data: [], backgroundColor: ANV.state.settings.primaryLightColor }] }, options: { responsive: true, indexAxis: 'y', plugins: { title: { display: true, text: 'Revenue by Source (YTD)' } } } });

            if(ANV.charts.expenseBreakdown) ANV.charts.expenseBreakdown.destroy();
            ANV.charts.expenseBreakdown = new Chart(chartContexts.expenseBreakdown, { type: 'doughnut', data: { labels: [], datasets: [{ label: 'Expenses', data: [], backgroundColor: [ANV.state.settings.primaryDeepColor, ANV.state.settings.primaryLightColor, ANV.state.settings.accentGoldColor, '#b2dfdb', '#ff8f00', '#ff6f00', '#757575'] }] }, options: { responsive: true, plugins: { title: { display: true, text: 'Expense Breakdown (YTD)' } } } });
        }
    },

    attachListeners: () => {
        document.querySelector('.app-nav').addEventListener('click', ANV.handlers.onTabClick);
        document.getElementById('logout-button').addEventListener('click', () => { sessionStorage.removeItem('anv_authenticated'); window.location.href = 'login.html'; });
        ANV.elements.modal.addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay') || e.target.classList.contains('modal-close-btn')) ANV.hideModal(); });
        ANV.elements.modalBody.addEventListener('submit', (e) => { if (e.target.id === 'booking-form') ANV.handlers.onSaveBooking(e); if (e.target.id === 'expense-form') ANV.handlers.onSaveExpense(e); });
        document.getElementById('add-booking-btn').addEventListener('click', () => ANV.handlers.showBookingModal());
        ANV.elements.bookings.searchInput.addEventListener('input', (e) => ANV.render.bookings(e.target.value));
        document.getElementById('export-bookings-csv').addEventListener('click', () => { const rows = [['CheckIn', 'Guest', 'Room', 'Source', 'Nights', 'RoomRate', 'CafeBill', 'Total', 'StayPaid', 'CafePaid', 'InvoiceNo']]; ANV.state.bookings.forEach(b => rows.push([b.checkIn, b.guest, b.room, b.source, b.nights, b.roomRate, b.cafeBill, b.total, b.stayPaid, b.cafePaid, b.invoiceNo])); ANV.util.exportToCsv('anandvan-bookings.csv', rows); });
        document.getElementById('add-expense-btn').addEventListener('click', () => ANV.handlers.showExpenseModal());
        ANV.elements.expenses.searchInput.addEventListener('input', (e) => ANV.render.expenses(e.target.value));
        document.getElementById('export-expenses-csv').addEventListener('click', () => { const rows = [['Date', 'Category', 'Subcategory', 'Vendor', 'Amount', 'PaymentMethod']]; ANV.state.expenses.forEach(e => rows.push([e.date, e.category, e.subcategory, e.vendor, e.amount, e.paymentMethod])); ANV.util.exportToCsv('anandvan-expenses.csv', rows); });
        ANV.elements.invoice.searchInput.addEventListener('input', (e) => ANV.render.invoiceStudio(e.target.value));
        document.getElementById('add-cafe-item-btn').addEventListener('click', ANV.handlers.onAddCafeItem);
        document.getElementById('print-cafe-bill').addEventListener('click', () => ANV.handlers.onPrint('cafe'));
        document.getElementById('print-voucher').addEventListener('click', () => ANV.handlers.onPrint('voucher'));
        document.getElementById('settings-form').addEventListener('submit', ANV.handlers.onSaveSettings);
        document.getElementById('save-menu-btn').addEventListener('click', ANV.handlers.onSaveMenu);
        document.getElementById('export-json-btn').addEventListener('click', () => ANV.util.downloadJson(ANV.state, 'anandvan-backup.json'));
        document.getElementById('import-json-input').addEventListener('change', ANV.handlers.onImportJson);
        document.getElementById('reset-data-btn').addEventListener('click', () => { if (confirm('DANGER! This will delete all data permanently. Are you absolutely sure?')) { localStorage.removeItem(window.ANV_CONFIG.localStorageKey); window.location.reload(); } });
    },
    
    showModal: (title, bodyHtml) => { ANV.elements.modalTitle.textContent = title; ANV.elements.modalBody.innerHTML = bodyHtml; ANV.elements.modal.classList.add('active'); },
    hideModal: () => { ANV.elements.modal.classList.remove('active'); ANV.elements.modalBody.innerHTML = ''; }
};

if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', ANV.init); } else { ANV.init(); }